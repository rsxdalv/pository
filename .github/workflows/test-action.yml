name: Test Pository Action

on:
  pull_request:
    paths:
      - 'action.yml'
      - '.github/workflows/test-action.yml'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  test-action:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y devscripts debhelper dh-exec
      
      - name: Install npm dependencies
        run: npm ci
      
      - name: Build Debian package
        run: |
          dpkg-buildpackage -us -uc -b
          mkdir -p dist
          mv ../pository_*.deb dist/
      
      - name: Get package filename
        id: package
        run: |
          DEB_FILE=$(ls dist/*.deb | head -1)
          echo "file=$DEB_FILE" >> $GITHUB_OUTPUT
          echo "filename=$(basename $DEB_FILE)" >> $GITHUB_OUTPUT
          echo "Package built: $(basename $DEB_FILE)"
      
      - name: Verify action.yml structure
        run: |
          echo "Verifying action.yml file structure..."
          
          # Check if action.yml exists
          if [ ! -f action.yml ]; then
            echo "::error::action.yml not found"
            exit 1
          fi
          
          # Check for required fields
          required_fields=("name" "description" "inputs" "runs")
          for field in "${required_fields[@]}"; do
            if ! grep -q "^${field}:" action.yml; then
              echo "::error::Missing required field: ${field}"
              exit 1
            fi
          done
          
          # Check for required inputs
          required_inputs=("host" "api-key" "file")
          for input in "${required_inputs[@]}"; do
            if ! grep -q "  ${input}:" action.yml; then
              echo "::error::Missing required input: ${input}"
              exit 1
            fi
          done
          
          echo "✓ action.yml structure is valid"
      
      - name: Test action with mock server (dry-run)
        id: test-upload
        continue-on-error: true
        uses: ./
        with:
          host: 'http://localhost:9999'
          api-key: 'test-api-key-for-validation'
          file: ${{ steps.package.outputs.file }}
          repo: 'test-repo'
          distribution: 'testing'
          component: 'main'
      
      - name: Check action execution
        run: |
          # The action should fail because there's no server at localhost:9999
          # But it should fail at the upload step, not at validation
          if [ "${{ steps.test-upload.outcome }}" == "success" ]; then
            echo "::error::Action should have failed with mock server"
            exit 1
          fi
          
          echo "✓ Action executed and failed as expected (no server available)"
          echo "This confirms the action is structurally correct and validates inputs properly"
      
      - name: Test action with real Pository instance (if configured)
        if: vars.POSITORY_URL != '' && secrets.POSITORY_API_KEY != ''
        uses: ./
        with:
          host: ${{ vars.POSITORY_URL }}
          api-key: ${{ secrets.POSITORY_API_KEY }}
          file: ${{ steps.package.outputs.file }}
          repo: 'ci-test'
          distribution: 'unstable'
          component: 'main'
      
      - name: Upload test package as artifact
        uses: actions/upload-artifact@v4
        with:
          name: test-debian-package
          path: dist/*.deb
